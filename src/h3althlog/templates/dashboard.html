{% extends "base.html" %}

{% block title %}Dashboard · H3althlog{% endblock %}

{% block content %}
<div class="page-week">

<h1>{{ week_label }}</h1>

<div class="week-bar">
  <a href="{{ url_for('main.dashboard', start=prev_start.isoformat()) }}">← Settimana precedente</a>
  <a href="{{ url_for('main.dashboard') }}">Oggi</a>
  <a href="{{ url_for('main.dashboard', start=next_start.isoformat()) }}">Settimana successiva →</a>
</div>


<!-- Intestazione giorni -->
<div class="week-grid">
  {% for d in week_days %}
    <div class="day-header">{{ d.strftime('%a')|capitalize }}</div>
  {% endfor %}
</div>

<!-- Box date -->
{% set today = current_date %}
<div class="week-grid">
  {% for d in week_days %}
    {% set classes = ["day-box"] %}
    {% if entries.get(d) %}
      {% set _ = classes.append("day-ok") %}
    {% else %}
      {% set _ = classes.append("day-empty") %}
    {% endif %}
    {% if d == today %}
      {% set _ = classes.append("day-today") %}
    {% endif %}

    <a href="{{ url_for('main.day_view', day=d.isoformat()) }}"
      class="{{ ' '.join(classes) }}">
      {{ d.strftime('%d/%m') }}


      <!-- Pallini pasti -->
  <div class="day-meals">
    {% for color in week_data[d].meals %}
      <span class="dot {{ color }}"></span>
    {% endfor %}
  </div>
</a>
  {% endfor %}

</div>

<div class="cards charts-row">
  <div class="card chart-card">
    <h3>🍽 Colazione</h3>
    {% if q_breakfast.total > 0 %}
      <div class="chart-wrap chart-sm"><canvas id="chartBreakfast"></canvas></div>
    {% else %}
      <div class="muted">– Nessun dato –</div>
    {% endif %}
  </div>

  <div class="card chart-card">
    <h3>🍝 Pranzo</h3>
    {% if q_lunch.total > 0 %}
      <div class="chart-wrap chart-sm"><canvas id="chartLunch"></canvas></div>
    {% else %}
      <div class="muted">– Nessun dato –</div>
    {% endif %}
  </div>

  <div class="card chart-card">
    <h3>🥗 Cena</h3>
    {% if q_dinner.total > 0 %}
      <div class="chart-wrap chart-sm"><canvas id="chartDinner"></canvas></div>
    {% else %}
      <div class="muted">– Nessun dato –</div>
    {% endif %}
  </div>
</div>

<div class="legend-inline">
  <span class="dot green"></span> Bene
  <span class="dot yellow"></span> Normale
  <span class="dot red"></span> Male
</div>


<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  (function () {
    const colors = ['#4caf50', '#fbc02d', '#f44336'];

    function initDonut(canvasId, data) {
      const el = document.getElementById(canvasId);
      if (!el || !data || data.total === 0) return;
      if (el.__chart) el.__chart.destroy();

      el.__chart = new Chart(el.getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: data.labels,        // ["Bene","Normale","Male"]
          datasets: [{ data: data.data, backgroundColor: colors, borderWidth: 0 }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false, // usa l'altezza del wrapper
          cutout: '55%',
          resizeDelay: 200,
          animation: { duration: 250 },
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (c) => `${c.label}: ${c.parsed}` } }
          }
        }
      });
    }

    const qb = {{ q_breakfast | tojson }};
    const ql = {{ q_lunch     | tojson }};
    const qd = {{ q_dinner    | tojson }};

    initDonut('chartBreakfast', qb);
    initDonut('chartLunch',     ql);
    initDonut('chartDinner',    qd);
  })();
</script>





</div>
{% endblock %}