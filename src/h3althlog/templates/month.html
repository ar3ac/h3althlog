{% extends 'base.html' %}
{% block content %}
<header class="month-header">
  <a href="{{ url_for('main.month_view', y=prev[0], m=prev[1], view=view_mode) }}" class="month-prev">«--</a>
  <h1 class="month-title">{{ label }}</h1>
  <a href="{{ url_for('main.month_view', y=next[0], m=next[1], view=view_mode) }}" class="month-next">--»</a>
</header>

<header class="month-view-toggle">
  {# Se view_mode non è definito o è 'default', il primo è attivo #}
  <a href="{{ url_for('main.month_view', y=y, m=m) }}"
     class="toggle-btn {% if not view_mode or view_mode == 'default' %}active{% endif %}">Pasti</a>
  <a href="{{ url_for('main.month_view', y=y, m=m, view='diet') }}"
     class="toggle-btn {% if view_mode == 'diet' %}active{% endif %}">Dieta</a>
  <a href="{{ url_for('main.month_view', y=y, m=m, view='steps') }}"
     class="toggle-btn {% if view_mode == 'steps' %}active{% endif %}">Passi</a>
  <a href="{{ url_for('main.month_view', y=y, m=m, view='weight') }}"
     class="toggle-btn {% if view_mode == 'weight' %}active{% endif %}">Peso</a>
</header>


<section class="month-grid">
  <div class="dow">Lun</div><div class="dow">Mar</div><div class="dow">Mer</div>
  <div class="dow">Gio</div><div class="dow">Ven</div><div class="dow">Sab</div><div class="dow">Dom</div>

{% for week in weeks %}
  {% for d in week %}
    {% set entry_data = entries.get(d) %}
    {% set b = entry_data[0] if entry_data else None %}
    {% set l = entry_data[1] if entry_data else None %}
    {% set c = entry_data[2] if entry_data else None %}
    {% set s = entry_data[3] if entry_data else None %}
    {% set w = entry_data[4] if entry_data else None %}
    {% set bd = entry_data[5] if entry_data else None %}
    {% set ld = entry_data[6] if entry_data else None %}
    {% set cd = entry_data[7] if entry_data else None %}

    {% set classes = ['day'] %}
    {% if d == today %}{% set _ = classes.append('day-today') %}{% endif %}
    {% if d.month != m %}{% set _ = classes.append('day-out') %}{% endif %}
    {% if entry_data %}{% set _ = classes.append('day-ok') %}{% else %}{% set _ = classes.append('day-empty') %}{% endif %}

    {# link diverso a seconda che esista o no l'entry #}
    {% set href = url_for('main.day_view', day=d.isoformat()) if entry_data
                 else url_for('entries.new_entry', date=d.isoformat()) %}

    <a class="{{ ' '.join(classes) }}" href="{{ href }}">
      <div class="day-hd">{{ d.day }}</div>
      <div class="day-pills">
        <span class="pill q{{ b or 0 }}" title="Colazione"></span>
        <span class="pill q{{ l or 0 }}" title="Pranzo"></span>
        <span class="pill q{{ c or 0 }}" title="Cena"></span>
      </div>
      <div class="day-icons">
        {% if view_mode == 'steps' and s is not none and s > 0 %}
          <span class="day-data-text {% if s >= 10000 %}steps-good{% else %}steps-bad{% endif %}"
                title="Passi: {{ s }}">{{ format_steps_full(s) }}</span>
        {% elif view_mode == 'weight' and w is not none and w > 0 %}
          <span class="day-data-text weight-value" title="Peso: {{ w }} kg">{{ w }}</span>
        {% elif view_mode == 'diet' and entry_data %}
          <div class="day-diet-icons">
            <span class="diet-icon" title="{{ get_diet_label(bd) }}">{{ get_diet_icon(bd) }}</span>
            <span class="diet-icon" title="{{ get_diet_label(ld) }}">{{ get_diet_icon(ld) }}</span>
            <span class="diet-icon" title="{{ get_diet_label(cd) }}">{{ get_diet_icon(cd) }}</span>
          </div>
        {% else %}
          {# Lascia lo spazio vuoto per mantenere l'allineamento #}
        {% endif %}
      </div>
    </a>
  {% endfor %}
{% endfor %}


</section>
{% endblock %}
