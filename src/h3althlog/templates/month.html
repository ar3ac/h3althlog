{% extends 'base.html' %}
{% block content %}
<header class="month-header">
  <a href="{{ url_for('main.month_view', y=prev[0], m=prev[1], view=view_mode) }}" class="month-prev">«--</a>
  <h1 class="month-title">{{ label }}</h1>
  <a href="{{ url_for('main.month_view', y=next[0], m=next[1], view=view_mode) }}" class="month-next">--»</a>
</header>

<header class="month-view-toggle">
  {# Se view_mode non è definito o è 'default', il primo è attivo #}
  <a href="{{ url_for('main.month_view', y=y, m=m) }}"
     class="toggle-btn {% if not view_mode or view_mode == 'default' %}active{% endif %}">Pasti</a>
  <a href="{{ url_for('main.month_view', y=y, m=m, view='diet') }}"
     class="toggle-btn {% if view_mode == 'diet' %}active{% endif %}">Dieta</a>
  <a href="{{ url_for('main.month_view', y=y, m=m, view='steps') }}"
     class="toggle-btn {% if view_mode == 'steps' %}active{% endif %}">Passi</a>
  <a href="{{ url_for('main.month_view', y=y, m=m, view='weight') }}"
     class="toggle-btn {% if view_mode == 'weight' %}active{% endif %}">Peso</a>
  <a href="{{ url_for('main.month_view', y=y, m=m, view='mood') }}"
     class="toggle-btn {% if view_mode == 'mood' %}active{% endif %}">Umore</a>
  <a href="{{ url_for('main.month_view', y=y, m=m, view='poop') }}" class="toggle-btn {% if view_mode == 'poop' %}active{% endif %}">Poop</a>
</header>


<section class="month-grid">
  <div class="dow">Lun</div><div class="dow">Mar</div><div class="dow">Mer</div>
  <div class="dow">Gio</div><div class="dow">Ven</div><div class="dow">Sab</div><div class="dow">Dom</div>

{% for week in weeks %}
  {% for d in week %}
    {% set entry_data = entries.get(d) %}
    {% set b = entry_data[0] if entry_data else None %}
    {% set l = entry_data[1] if entry_data else None %}
    {% set c = entry_data[2] if entry_data else None %}
    {% set s = entry_data[3] if entry_data else None %}
    {% set w = entry_data[4] if entry_data else None %}
    {% set bd = entry_data[5] if entry_data else None %}
    {% set ld = entry_data[6] if entry_data else None %}
    {% set cd = entry_data[7] if entry_data else None %}
    {% set mood = entry_data[8] if entry_data else None %}
    {% set poop = entry_data[9] if entry_data else None %}

    {% set classes = ['day'] %}
    {% if d == today %}{% set _ = classes.append('day-today') %}{% endif %}
    {% if d.month != m %}{% set _ = classes.append('day-out') %}{% endif %}
    {% if entry_data %}{% set _ = classes.append('day-ok') %}{% else %}{% set _ = classes.append('day-empty') %}{% endif %}

    {# link diverso a seconda che esista o no l'entry #}
    {% set href = '' %}
    {% if not entry_data %}
      {# Se non c'è entry, vai sempre a creare una nuova #}
      {% set href = url_for('entries.new_entry', date=d.isoformat()) %}
    {% elif d == today %}
      {# Se c'è entry ed è oggi, vai direttamente in modifica #}
      {% set href = url_for('entries.edit_entry', entry_date=d.isoformat()) %}
    {% else %}
      {# Se c'è entry ma non è oggi, vai in visualizzazione #}
      {% set href = url_for('main.day_view', day=d.isoformat()) %}
    {% endif %}

    <a class="{{ ' '.join(classes) }}" href="{{ href }}">
      <div class="day-hd">{{ d.day }}</div>
      <div class="day-pills">
        <span class="pill q{{ b or 0 }}" title="Colazione"></span>
        <span class="pill q{{ l or 0 }}" title="Pranzo"></span>
        <span class="pill q{{ c or 0 }}" title="Cena"></span>
      </div>
      <div class="day-icons">
        {% if view_mode == 'steps' and s is not none and s > 0 %}
          <span class="day-data-text {% if s >= 10000 %}steps-good{% else %}steps-bad{% endif %}"
                title="Passi: {{ s }}">{{ format_steps_full(s) }}</span>
        {% elif view_mode == 'weight' and w is not none and w > 0 %}
          <span class="day-data-text weight-value" title="Peso: {{ w }} kg">{{ format_weight(w) }}</span>
        {% elif view_mode == 'diet' and entry_data %}
          <div class="day-diet-icons">
            <span class="diet-icon" title="{{ get_diet_label(bd) }}">{{ get_diet_icon(bd) }}</span>
            <span class="diet-icon" title="{{ get_diet_label(ld) }}">{{ get_diet_icon(ld) }}</span>
            <span class="diet-icon" title="{{ get_diet_label(cd) }}">{{ get_diet_icon(cd) }}</span>
          </div>
        {% elif view_mode == 'mood' and mood is not none %}
          <span class="day-icon">{{ get_mood_icon(mood) }}</span>
        {% elif view_mode == 'poop' and poop is not none %}
          <span class="day-icon">{{ get_poop_icon(poop) }}</span>
        {% else %}
          {# Lascia lo spazio vuoto per mantenere l'allineamento #}
        {% endif %}
      </div>
    </a>
  {% endfor %}
{% endfor %}


 </section>

{% if not view_mode or view_mode == 'default' %}
<section class="month-summary">
  {% set has_data = (meal_chart_data.breakfast | sum > 0) or (meal_chart_data.lunch | sum > 0) or (meal_chart_data.dinner | sum > 0) %}
  {% if has_data %}
  <div class="cards charts-row">
    <div class="card chart-card">
      <h3>Colazione</h3>
      <div class="chart-wrap chart-sm">
        <div id="chartMonthBreakfast"></div>
      </div>
    </div>
    <div class="card chart-card">
      <h3>Pranzo</h3>
      <div class="chart-wrap chart-sm">
        <div id="chartMonthLunch"></div>
      </div>
    </div>
    <div class="card chart-card">
      <h3>Cena</h3>
      <div class="chart-wrap chart-sm">
        <div id="chartMonthDinner"></div>
      </div>
    </div>
  </div>
  {% else %}
  <div class="card" style="margin-top: 1.5rem;">
      <p class="muted" style="text-align: center; margin: .5rem 0;">Nessun dato sui pasti disponibile per questo mese.</p>
  </div>
  {% endif %}
</section>
{% endif %}
{% endblock %}

{% block scripts %}
{% if not view_mode or view_mode == 'default' %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
window.addEventListener("load", function() {
  // Opzioni comuni per i grafici a ciambella
  const commonOptions = {
    chart: { type: 'donut', sparkline: { enabled: true } },
    stroke: { width: 0 },
    plotOptions: {
      pie: {
        donut: {
          size: '75%',
          labels: {
            show: true,
            total: {
              show: true,
              showAlways: true,
              fontSize: '16px',
              fontWeight: 600,
              color: '#555'
            }
          }
        }
      }
    },
    colors: ['#4caf50', '#fbc02d', '#f44336'], // Verde, Giallo, Rosso
    labels: ['Ottima', 'Normale', 'Esagerata'],
    legend: { show: false },
    tooltip: {
      y: { formatter: (val) => `${val} ${val === 1 ? 'volta' : 'volte'}` }
    }
  };

  // Funzione per creare un grafico se ci sono dati
  function createChart(selector, seriesData) {
    if (seriesData.reduce((a, b) => a + b, 0) > 0) {
      const options = { ...commonOptions, series: seriesData };
      new ApexCharts(document.querySelector(selector), options).render();
    }
  }

  createChart("#chartMonthBreakfast", {{ meal_chart_data.breakfast | tojson }});
  createChart("#chartMonthLunch", {{ meal_chart_data.lunch | tojson }});
  createChart("#chartMonthDinner", {{ meal_chart_data.dinner | tojson }});
});
</script>
{% endif %}
{% endblock %}
